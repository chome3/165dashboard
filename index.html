<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>防詐騙路由轉發系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 定義路由資料 (更新為單一目標)
            const routes = [
                {
                    path: "/",
                    type: "Proxy",
                    color: "blue",
                    description: "根目錄代理。所有流量統一轉發至 Vercel。",
                    dest: "Vercel App"
                },
                {
                    path: "/dr",
                    type: "Redirect",
                    color: "amber",
                    description: "直接轉址模式。回傳 HTTP 302 跳轉至 Vercel。",
                    dest: "Vercel App"
                },
                {
                    path: "/*",
                    type: "Wildcard",
                    color: "purple",
                    description: "全域路徑代理。任何子路徑皆轉發至 Vercel。",
                    dest: "Vercel App"
                }
            ];

            // 內網判斷邏輯 (僅供 Dashboard 顯示資訊用，不影響路由)
            const checkInternal = (ip) => {
                const subnets = ['60.249.9.', '60.249.21.', '203.69.10.'];
                return subnets.some(subnet => ip.startsWith(subnet));
            };

            // 取得使用者 IP
            const ipDisplay = document.getElementById('user-ip');
            const statusDisplay = document.getElementById('user-status');
            
            fetch('https://www.cloudflare.com/cdn-cgi/trace')
                .then(res => res.text())
                .then(data => {
                    const ipLine = data.split('\n').find(l => l.startsWith('ip='));
                    if (ipLine) {
                        const ip = ipLine.split('=')[1];
                        ipDisplay.innerText = ip;
                        
                        if (checkInternal(ip)) {
                            statusDisplay.innerHTML = '<span class="text-emerald-600 font-bold">● 內部 IP (已列入白名單)</span>';
                        } else {
                            statusDisplay.innerHTML = '<span class="text-slate-500 font-bold">● 外部 IP</span>';
                        }
                    }
                })
                .catch(() => {
                    ipDisplay.innerText = '未知';
                });

            // 渲染路由卡片
            const container = document.getElementById('routes-container');
            
            routes.forEach(route => {
                let badgeClass = '';
                if (route.type === 'Proxy') badgeClass = 'bg-blue-100 text-blue-700';
                else if (route.type === 'Redirect') badgeClass = 'bg-amber-100 text-amber-700';
                else badgeClass = 'bg-purple-100 text-purple-700';

                const debugLink = route.path.includes('*') 
                    ? '' 
                    : `<a href="${route.path === '/' ? '/?debug=true' : route.path + '?debug=true'}" target="_blank" class="text-xs font-semibold text-indigo-600 hover:text-indigo-800 border border-indigo-200 px-2 py-1 rounded">Debug &rarr;</a>`;

                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden';
                card.innerHTML = `
                    <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                        <div class="flex items-center gap-3">
                            <span class="font-mono text-lg font-bold text-slate-700">${route.path}</span>
                            <span class="px-2 py-0.5 text-xs font-bold uppercase rounded-full ${badgeClass}">${route.type}</span>
                        </div>
                        ${debugLink}
                    </div>
                    <div class="p-6">
                        <p class="text-slate-600 text-sm mb-4">${route.description}</p>
                        <div class="w-full text-xs p-3 bg-slate-50 border border-slate-200 rounded flex items-center">
                            <span class="font-bold text-slate-700 mr-2">目標 (Target):</span>
                            <span class="text-slate-900 font-mono">${route.dest}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        });
    </script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <div class="min-h-screen py-10 px-4">
        <div class="max-w-4xl mx-auto">
            <header class="text-center mb-10">
                <h1 class="text-3xl font-extrabold text-slate-900 mb-2">路由轉發控制台</h1>
                <p class="text-slate-500 text-sm">統一轉發模式 (Unified Vercel Forwarding)</p>
                <div class="mt-4 inline-block bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200 text-sm text-left">
                    <div>您的 IP: <span class="font-mono font-bold text-slate-700" id="user-ip">檢測中...</span></div>
                    <div id="user-status" class="mt-1 text-xs">檢測中...</div>
                </div>
            </header>

            <div id="routes-container" class="space-y-4 mb-10"></div>

            <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-6">
                <h3 class="font-bold text-indigo-900 mb-4">快速測試工具</h3>
                <div class="flex flex-wrap gap-3">
                    <a href="/?debug=true" target="_blank" class="px-4 py-2 bg-white text-indigo-600 text-sm font-medium rounded border border-indigo-200 hover:bg-indigo-50">檢查轉發 (Root)</a>
                    <a href="/dr?debug=true" target="_blank" class="px-4 py-2 bg-white text-amber-600 text-sm font-medium rounded border border-amber-200 hover:bg-amber-50">檢查轉址 (/dr)</a>
                    <a href="/dashboard" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded hover:bg-indigo-700">重新載入儀表板</a>
                </div>
            </div>

            <footer class="mt-10 text-center text-xs text-slate-400">
                <p>目前系統設定：所有流量 (內網/外網) 皆轉發至 Vercel</p>
                <p>白名單 IP 僅供識別參考</p>
            </footer>
        </div>
    </div>
<script type="module" src="/index.tsx"></script>
</body>
</html>