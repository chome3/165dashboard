<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>防詐騙路由轉發系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 定義路由資料
            const routes = [
                {
                    path: "/",
                    type: "Proxy",
                    color: "blue",
                    description: "根目錄代理。根據 IP 轉發至 GAS (內網) 或 Vercel (外網)。",
                    internalDest: "Google Apps Script",
                    externalDest: "Vercel App"
                },
                {
                    path: "/dr",
                    type: "Redirect",
                    color: "amber",
                    description: "直接轉址模式。回傳 HTTP 302 跳轉至目標網址。",
                    internalDest: "Google Apps Script",
                    externalDest: "Vercel App"
                },
                {
                    path: "/static/*",
                    type: "Asset",
                    color: "green",
                    description: "靜態資源代理。僅限內網 IP 存取 GAS 資源。",
                    internalDest: "script.google.com/static/...",
                    externalDest: "N/A (Forbidden)"
                }
            ];

            // 內網判斷邏輯 (前端僅供顯示參考，實際邏輯在後端)
            const checkInternal = (ip) => {
                const subnets = ['60.249.9.', '60.249.21.', '203.69.10.'];
                return subnets.some(subnet => ip.startsWith(subnet));
            };

            // 取得使用者 IP
            const ipDisplay = document.getElementById('user-ip');
            const statusDisplay = document.getElementById('user-status');
            
            fetch('https://www.cloudflare.com/cdn-cgi/trace')
                .then(res => res.text())
                .then(data => {
                    const ipLine = data.split('\n').find(l => l.startsWith('ip='));
                    if (ipLine) {
                        const ip = ipLine.split('=')[1];
                        ipDisplay.innerText = ip;
                        
                        if (checkInternal(ip)) {
                            statusDisplay.innerHTML = '<span class="text-emerald-600 font-bold">● 內部網路 (Internal)</span>';
                        } else {
                            statusDisplay.innerHTML = '<span class="text-pink-600 font-bold">● 外部網路 (External)</span>';
                        }
                    }
                })
                .catch(() => {
                    ipDisplay.innerText = '未知';
                });

            // 渲染路由卡片
            const container = document.getElementById('routes-container');
            
            routes.forEach(route => {
                let badgeClass = '';
                if (route.type === 'Proxy') badgeClass = 'bg-blue-100 text-blue-700';
                else if (route.type === 'Redirect') badgeClass = 'bg-amber-100 text-amber-700';
                else badgeClass = 'bg-green-100 text-green-700';

                const debugLink = route.path.includes('*') 
                    ? '' 
                    : `<a href="${route.path === '/' ? '/?debug=true' : route.path + '?debug=true'}" target="_blank" class="text-xs font-semibold text-indigo-600 hover:text-indigo-800 border border-indigo-200 px-2 py-1 rounded">Debug &rarr;</a>`;

                card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden';
                card.innerHTML = `
                    <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                        <div class="flex items-center gap-3">
                            <span class="font-mono text-lg font-bold text-slate-700">${route.path}</span>
                            <span class="px-2 py-0.5 text-xs font-bold uppercase rounded-full ${badgeClass}">${route.type}</span>
                        </div>
                        ${debugLink}
                    </div>
                    <div class="p-6">
                        <p class="text-slate-600 text-sm mb-4">${route.description}</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-xs p-2 bg-emerald-50 border border-emerald-100 rounded">
                                <span class="font-bold text-emerald-700">內網去向:</span><br>${route.internalDest}
                            </div>
                            <div class="text-xs p-2 bg-pink-50 border border-pink-100 rounded">
                                <span class="font-bold text-pink-700">外網去向:</span><br>${route.externalDest}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        });
    </script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <div class="min-h-screen py-10 px-4">
        <div class="max-w-4xl mx-auto">
            <header class="text-center mb-10">
                <h1 class="text-3xl font-extrabold text-slate-900 mb-2">路由轉發控制台</h1>
                <div class="inline-block bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200 text-sm text-left">
                    <div>您的 IP: <span class="font-mono font-bold text-slate-700" id="user-ip">檢測中...</span></div>
                    <div id="user-status" class="mt-1 text-xs">檢測中...</div>
                </div>
            </header>

            <div id="routes-container" class="space-y-4 mb-10"></div>

            <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-6">
                <h3 class="font-bold text-indigo-900 mb-4">快速測試工具</h3>
                <div class="flex flex-wrap gap-3">
                    <a href="/?debug=true" target="_blank" class="px-4 py-2 bg-white text-indigo-600 text-sm font-medium rounded border border-indigo-200 hover:bg-indigo-50">檢查根目錄路由</a>
                    <a href="/dr?debug=true" target="_blank" class="px-4 py-2 bg-white text-amber-600 text-sm font-medium rounded border border-amber-200 hover:bg-amber-50">檢查 /dr 路由</a>
                    <a href="/dashboard" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded hover:bg-indigo-700">重新載入儀表板</a>
                </div>
            </div>

            <footer class="mt-10 text-center text-xs text-slate-400">
                <p>白名單網段: <span class="font-mono">60.249.9.0/24</span>, <span class="font-mono">60.249.21.0/24</span>, <span class="font-mono">203.69.10.0/24</span></p>
                <p>若要存取此頁面，請使用 <a href="/dashboard" class="underline">/dashboard</a> 路徑</p>
            </footer>
        </div>
    </div>
<script type="module" src="/index.tsx"></script>
</body>
</html>